generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String   @id @default(cuid())
  supabaseId     String?  @unique
  email          String   @unique
  userProfilePic String[]
  name           String
  password       String?
  role           Role     @default(CLIENT)
  phone          String?  @default("No phone number added")
  avatar         String?
  stripeAccountId String?   @unique
  keyBalance     Int      @default(0)
  isVerified     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  description    String?  @default("No description added")
  skills         String[]
  hourlyPay      String?
  fixedPrice     String?
  halfhourPay    String?
  gigs           Gig[]
  location       String?  @default("No location added")
  portfolio      String[]
  Bio            String?  @default("No bio added")
  availabilty    String?  @default("No availability added")

  // Relations
  jobs           Job[]
  applications   Application[]
  shop           Shop?
  sentMessages   Message[]     @relation("SentMessages")
  receivedMessages Message[]   @relation("ReceivedMessages")
  onboardingComplete  Boolean   @default(false)
  stripeCustomerId String? @unique


  clientContracts   Contract[]       @relation("ClientContracts")
  talentContracts   Contract[]       @relation("TalentContracts")

  talentOrders   Order[]       @relation("TalentOrders")
  clientOrders   Order[]       @relation("ClientOrders")
  subscription   Subscription? @relation("UserSubscription")
  userReviews    Review[] @relation("UserReviews")
  talentReviews  Review[] @relation("TalentReviews")
  clientGettingReviews ClientReview[] @relation("ClientGettingReviews")
  talentGivingReviews ClientReview[] @relation("TalentGivingReviews")
}

enum Role {
  CLIENT
  TALENT
  ADMIN
}

model Order {
  id                    String   @id @default(uuid())
  amount                Int      // Amount in cents ($100 = 10000)
  platformFee           Int      // Your commission in cents
  status                OrderStatus   @default(PENDING) // pending, completed, refunded
  stripePaymentIntentId String?
  contractId            String?
  contract              Contract? @relation(fields: [contractId], references: [id])
  talentId              String
  talent                User     @relation("TalentOrders", fields: [talentId], references: [id])
  stripeAccountId       String?
  
  clientId               String
  client                 User     @relation("ClientOrders", fields: [clientId], references: [id])
  
  createdAt             DateTime @default(now())
}
enum OrderStatus {
  PENDING

  CHARGED
  COMPLETED
  CANCELLED
}

model Gig {
  id             String  @id @default(cuid())
  userId         String
  user           User    @relation(fields: [userId], references: [id])
  price          Int     @default(0)
  name           String
  gigDescription String
  hourlyPrice    Boolean
  fixedPrice     Boolean
}

model Shop {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  title       String
  description String
  category    String[]
  hourlyRate  Float?
  portfolio   String[] // image URLs
  isActive    Boolean  @default(true)
  monthlyKeys Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Job {
  id       String @id @default(cuid())
  clientId String
  client   User   @relation(fields: [clientId], references: [id])

  title       String
  description String
  category    String
  categories  String[]
  skills      String[]
  location    String?
  timeline    String
  paymentType PaymentType
  budget      Float
  status      JobStatus   @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  applications Application[]
  messages     Message[]
  contracts    Contract[]
  reviews Review[]
  clientReviews ClientReview[]
}

enum PaymentType {
  HOURLY
  FIXED
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Application {
  id           String            @id @default(cuid())
  jobId        String
  job          Job               @relation(fields: [jobId], references: [id])
  talentId     String
  talent       User              @relation(fields: [talentId], references: [id])
  coverLetter  String?
  proposedRate Float?
  timeline     String?
  status       ApplicationStatus @default(PENDING)
  keysUsed     Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  senderName String?
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  receiverName String?
  jobId      String?
  job        Job?     @relation(fields: [jobId], references: [id])
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Contract{
  id String @id @default(cuid())
  jobId String
  job Job @relation(fields: [jobId], references: [id])
  clientId    String
  client      User @relation("ClientContracts", fields: [clientId], references: [id])
  
  talentId    String
  talent      User @relation("TalentContracts", fields: [talentId], references: [id])
  status ContractStatus @default(ACTIVE)
  updatedBy String?
  description String
  accepted Boolean? 
  rate Float?
  paymentType PaymentType @default(HOURLY)
  timeline String?
  stripePaymentIntentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders Order[]
  reviews Review[]
  clientReviews ClientReview[]
}

model Subscription {
  id String @id @default(cuid())
  userId String @unique
  user User @relation("UserSubscription", fields: [userId], references: [id], onDelete: Cascade)
  stripeSubscriptionId String @unique
  stripeCustomerId String
  stripePriceId String
  cancelAtPeriodEnd Boolean @default(false)
  status Status 
  planType PlanType?
  scheduleForDowngrade Boolean @default(false)
  subscriptionScheduledForDowngrade PlanType?
  currentPeriodStart DateTime?
  lastKeyAllocation DateTime?
  nextKeyAllocation DateTime?
  currentPeriodEnd DateTime?

}

model Review{
  id String @id @default(cuid())
  userId String 
  user User @relation("UserReviews", fields: [userId], references: [id])
  talentId String 
  talent User @relation("TalentReviews", fields: [talentId], references: [id])
  rating Int
  jobId String @unique
  contractId String @unique
  contract Contract @relation(fields: [contractId], references: [id])
  job Job @relation(fields: [jobId], references: [id])
  review String
  createdAt DateTime @default(now()) 
  updatedAt DateTime @updatedAt
}

model ClientReview{
  id String @id @default(cuid())
  userId String 
  user User @relation("ClientGettingReviews", fields: [userId], references: [id])
  talentId String 
  talent User @relation("TalentGivingReviews", fields: [talentId], references: [id])
  rating Int
  contractId String @unique
  contract Contract @relation(fields: [contractId], references: [id])
  jobId String @unique
  job Job @relation(fields: [jobId], references: [id])
  review String
  createdAt DateTime @default(now()) 
  updatedAt DateTime @updatedAt
}

enum Status {
  active
  trailing
  past_due
  cancelled

}
enum PlanType {
  basic_plan
  premium_tier
  pro_plan

}

enum ContractStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}